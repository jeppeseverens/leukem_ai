hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(subtitle = "Pediatric enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "bottom",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Combine with patchwork ----
p_final <- p_top / p_bottom +
plot_layout(heights = c(1, 1.2))   # adjust bottom panel height if needed
p_final
library(dplyr)
library(ggplot2)
library(patchwork)
# Split data by enrichment
dat_top    <- f1_per_class_enriched %>% filter(enrichment_class == "Adult-enriched")
dat_bottom <- f1_per_class_enriched %>% filter(enrichment_class != "Adult-enriched")
# ---- Plot 1: Top enrichment ----
p_top <- ggplot(dat_top,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.65),
width = 0.55, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(title = "LOSO performance per AML subtype",
subtitle = "Adult enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "none",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Plot 2: Bottom enrichment ----
p_bottom <- ggplot(dat_bottom,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.65),
width = 0.55, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(subtitle = "Pediatric enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "bottom",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Combine with patchwork ----
p_final <- p_top / p_bottom +
plot_layout(heights = c(3, 8))   # adjust bottom panel height if needed
p_final
library(dplyr)
library(ggplot2)
library(patchwork)
# Split data by enrichment
dat_top    <- f1_per_class_enriched %>% filter(enrichment_class == "Adult-enriched")
dat_bottom <- f1_per_class_enriched %>% filter(enrichment_class != "Adult-enriched")
# ---- Plot 1: Top enrichment ----
p_top <- ggplot(dat_top,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.75),
width = 0.55, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(title = "LOSO performance per AML subtype",
subtitle = "Adult enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "none",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Plot 2: Bottom enrichment ----
p_bottom <- ggplot(dat_bottom,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.75),
width = 0.55, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(subtitle = "Pediatric enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "bottom",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Combine with patchwork ----
p_final <- p_top / p_bottom +
plot_layout(heights = c(3, 8))   # adjust bottom panel height if needed
p_final
library(dplyr)
library(ggplot2)
library(patchwork)
# Split data by enrichment
dat_top    <- f1_per_class_enriched %>% filter(enrichment_class == "Adult-enriched")
dat_bottom <- f1_per_class_enriched %>% filter(enrichment_class != "Adult-enriched")
# ---- Plot 1: Top enrichment ----
p_top <- ggplot(dat_top,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.75),
width = 0.65, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(title = "LOSO performance per AML subtype",
subtitle = "Adult enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "none",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Plot 2: Bottom enrichment ----
p_bottom <- ggplot(dat_bottom,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.75),
width = 0.55, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(subtitle = "Pediatric enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "bottom",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Combine with patchwork ----
p_final <- p_top / p_bottom +
plot_layout(heights = c(3, 8))   # adjust bottom panel height if needed
p_final
library(dplyr)
library(ggplot2)
library(patchwork)
# Split data by enrichment
dat_top    <- f1_per_class_enriched %>% filter(enrichment_class == "Adult-enriched")
dat_bottom <- f1_per_class_enriched %>% filter(enrichment_class != "Adult-enriched")
# ---- Plot 1: Top enrichment ----
p_top <- ggplot(dat_top,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.75),
width = 0.65, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(title = "LOSO performance per AML subtype",
subtitle = "Adult enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "none",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Plot 2: Bottom enrichment ----
p_bottom <- ggplot(dat_bottom,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.75),
width = 0.65, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(subtitle = "Pediatric enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "bottom",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Combine with patchwork ----
p_final <- p_top / p_bottom +
plot_layout(heights = c(3, 8))   # adjust bottom panel height if needed
p_final
library(dplyr)
library(ggplot2)
library(patchwork)
# Split data by enrichment
dat_top    <- f1_per_class_enriched %>% filter(enrichment_class == "Adult-enriched")
dat_bottom <- f1_per_class_enriched %>% filter(enrichment_class != "Adult-enriched")
# ---- Plot 1: Top enrichment ----
p_top <- ggplot(dat_top,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.85),
width = 0.75, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(title = "LOSO performance per AML subtype",
subtitle = "Adult enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "none",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Plot 2: Bottom enrichment ----
p_bottom <- ggplot(dat_bottom,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.85),
width = 0.75, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.65),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(subtitle = "Pediatric enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "bottom",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Combine with patchwork ----
p_final <- p_top / p_bottom +
plot_layout(heights = c(3, 8))   # adjust bottom panel height if needed
p_final
library(dplyr)
library(ggplot2)
library(patchwork)
# Split data by enrichment
dat_top    <- f1_per_class_enriched %>% filter(enrichment_class == "Adult-enriched")
dat_bottom <- f1_per_class_enriched %>% filter(enrichment_class != "Adult-enriched")
# ---- Plot 1: Top enrichment ----
p_top <- ggplot(dat_top,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.85),
width = 0.75, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.85),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(title = "LOSO performance per AML subtype",
subtitle = "Adult enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "none",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Plot 2: Bottom enrichment ----
p_bottom <- ggplot(dat_bottom,
aes(x = subtype, y = f1, fill = cohort_type)) +
geom_col(position = position_dodge(width = 0.85),
width = 0.75, alpha = 0.85) +
geom_text(aes(label = sprintf("%.2f", f1)),
position = position_dodge(width = 0.85),
hjust = 1.05, size = 2.7, color = "black") +
coord_flip() +
scale_fill_manual(values = c("Pediatric"="#e67e62","Adult"="#5a9acb"),
name="Cohort type") +
scale_y_continuous(limits = c(0,1), expand = expansion(mult=c(0,0.05))) +
labs(subtitle = "Pediatric enriched classes",
x = "Subtype", y = "F1 score") +
theme_bw() +
theme(
legend.position = "bottom",
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 8),
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(size = 0.3, color = "grey80")
)
# ---- Combine with patchwork ----
p_final <- p_top / p_bottom +
plot_layout(heights = c(3, 8))   # adjust bottom panel height if needed
p_final
library(dplyr)
library(ggplot2)
# Summarise mean F1 by (cohort_type Ã— enrichment_class)
summary_df <- f1_per_class_enriched %>%
group_by(cohort_type, enrichment_class) %>%
summarise(mean_f1 = mean(f1, na.rm = TRUE), .groups = "drop")
# Simple comparison barplot
p_summary <- ggplot(summary_df,
aes(x = enrichment_class,
y = mean_f1,
fill = cohort_type)) +
geom_col(position = "dodge", width = 0.6, alpha = 0.9) +
geom_text(aes(label = sprintf("%.2f", mean_f1)),
position = position_dodge(width = 0.6),
vjust = -0.4,
size = 3,
color = "black") +
scale_fill_manual(values = c("Pediatric" = "#e67e62",
"Adult" = "#5a9acb"),
name = "Cohort type") +
scale_y_continuous(limits = c(0, 1),
expand = expansion(mult = c(0, 0.1))) +
labs(title = "Mean F1 score: pediatric vs adult cohorts",
subtitle = "Across pediatric-enriched vs adult-enriched AML subtypes",
x = "Enrichment class",
y = "Mean F1 score") +
theme_bw() +
theme(
legend.position = "bottom",
plot.title = element_text(size = 12, face = "bold"),
axis.text.x = element_text(size = 9)
)
p_summary
# Binned kappa and accuracy by age
age_bins <- seq(0, 90, by = 5)
age_performance <- data.frame()
for (i in 1:(length(age_bins)-1)) {
age_min <- age_bins[i]
age_max <- age_bins[i+1]
subset_data <- sample_level_age[sample_level_age$age_years >= age_min &
sample_level_age$age_years < age_max, ]
if (nrow(subset_data) >= 10) {  # Need reasonable sample size for kappa
# Calculate kappa for this age bin
cm <- caret::confusionMatrix(
factor(subset_data$prediction_display, levels = unique(c(subset_data$truth_display, subset_data$prediction_display))),
factor(subset_data$truth_display, levels = unique(c(subset_data$truth_display, subset_data$prediction_display)))
)
kappa <- as.numeric(cm$overall["Kappa"])
accuracy <- mean(subset_data$correct)
age_performance <- rbind(age_performance, data.frame(
age_mid = (age_min + age_max) / 2,
age_label = sprintf("%d-%d", age_min, age_max),
n = nrow(subset_data),
accuracy = accuracy,
kappa = kappa,
se_accuracy = sd(subset_data$correct) / sqrt(nrow(subset_data))
))
}
}
# Plot kappa by age with accuracy overlay
p_age_kappa <- ggplot(age_performance, aes(x = age_mid, y = kappa)) +
geom_point(aes(size = n), alpha = 0.7, color = "#7eb0d5") +
geom_smooth(method = "loess", se = TRUE, color = "#7eb0d5", fill = "#7eb0d5",
alpha = 0.2, formula = y ~ x) +
geom_vline(xintercept = 18, linetype = "dashed", color = "gray40", alpha = 0.5) +
annotate("text", x = 18, y = min(age_performance$kappa) - 0.02,
label = "Pediatric/Adult\nBoundary", vjust = 1, size = 3, color = "gray40") +
scale_size_continuous(range = c(3, 12), name = "Sample Size") +
theme_bw() +
labs(
title = "Prediction Performance by Patient Age",
subtitle = sprintf("Based on LOSO validation (n=%d patients)", nrow(sample_level_age)),
x = "Age (years)",
y = "Cohen's Kappa"
) +
ylim(min(age_performance$kappa) - 0.1, 1) +
theme(text = element_text(size = 12))
print(p_age_kappa)
ggsave("../writing/figures/age_effect_on_performance.png", p_age_kappa,
width = 10, height = 6, dpi = 300)
View(meta)
modify_classes <- function(vector) {
vector[grepl("MDS|TP53|MECOM", vector)] <- "MDS.r/MECOM"
vector[!grepl("MLLT3", vector) & grepl("KMT2A", vector)] <- "other.KMT2A"
vector
}
# Filters
DATA_FILTERS <- list(
min_samples_per_subtype = 10,
excluded_subtypes = c("AML NOS", "Missing data", "Multi"),
selected_studies = c(
"TCGA-LAML",
"LEUCEGENE",
"BEATAML1.0-COHORT",
"AAML0531",
"AAML1031",
"AAML03P1",
"100LUMC"
)
)
# Load mapping of class labels to numeric labels
label_mapping <- read.csv("../data/label_mapping_all.csv")
# Load leukemia subtype data
leukemia_subtypes <- read.csv("../data/rgas_20aug25.csv")$ICC_Subtype
# Load study metadata
meta <- read.csv("../data/meta_20aug25.csv")
study_names <- meta$Studies
# Filter data based on criteria
subtypes_with_sufficient_samples <- names(which(table(leukemia_subtypes) >= DATA_FILTERS$min_samples_per_subtype))
filter <- which(
leukemia_subtypes %in% subtypes_with_sufficient_samples &
!leukemia_subtypes %in% DATA_FILTERS$excluded_subtypes &
study_names %in% DATA_FILTERS$selected_studies
)
leukemia_subtypes_mod <- modify_classes(leukemia_subtypes)
filtered_leukemia_subtypes <- leukemia_subtypes[filter]
# Load study metadata
filtered_study_names <- study_names[filter]
meta <- meta[filter, ]
meta$class <- filtered_leukemia_subtypes
load("~/Downloads/marlin_v1.classes.RData")
y
table(y)
modify_classes <- function(vector) {
vector[grepl("MDS|TP53|MECOM", vector)] <- "MDS.r/MECOM"
vector[!grepl("MLLT3", vector) & grepl("KMT2A", vector)] <- "other.KMT2A"
vector
}
# Filters
DATA_FILTERS <- list(
min_samples_per_subtype = 10,
excluded_subtypes = c("AML NOS", "Missing data", "Multi"),
selected_studies = c(
"TCGA-LAML",
"LEUCEGENE",
"BEATAML1.0-COHORT",
"AAML0531",
"AAML1031",
"AAML03P1",
"100LUMC"
)
)
# Load mapping of class labels to numeric labels
label_mapping <- read.csv("../data/label_mapping_all.csv")
# Load leukemia subtype data
leukemia_subtypes <- read.csv("../data/rgas_20aug25.csv")$ICC_Subtype
# Load study metadata
meta <- read.csv("../data/meta_20aug25.csv")
study_names <- meta$Studies
# Filter data based on criteria
subtypes_with_sufficient_samples <- names(which(table(leukemia_subtypes) >= DATA_FILTERS$min_samples_per_subtype))
filter <- which(
leukemia_subtypes %in% subtypes_with_sufficient_samples &
!leukemia_subtypes %in% DATA_FILTERS$excluded_subtypes &
study_names %in% DATA_FILTERS$selected_studies
)
leukemia_subtypes_mod <- modify_classes(leukemia_subtypes)
filtered_leukemia_subtypes <- leukemia_subtypes[filter]
# Load study metadata
filtered_study_names <- study_names[filter]
meta <- meta[filter, ]
meta$classes <- filtered_leukemia_subtypes
View(meta)
